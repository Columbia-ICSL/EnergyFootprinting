<!doctype>
<html>
<head>
<title> The Energy Footprint System query interface </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!--<script src="http://code.highcharts.com/highcharts.js"></script> -->
<script src="http://code.highcharts.com/stock/highstock.js"></script>
<script type="text/javascript">
var query=(function(s){
  var loc=s.indexOf('?');
  if(loc==-1)return {};
  var q=s.substr(loc+1);
  var ret={};
  q.split('&').map(function(part){
    var array=part.split('=');
    var key=decodeURIComponent(array[0]), value=decodeURIComponent(array.slice(1).join("="));
    ret[key]=value;
  });
  return ret;
})(location.href);

var chart;
var personID=query['id'];

var maxLen=(20*60/10);//20mins, every 10s
var reqTime=3*1000;
var types=[false];
var LastRoom=false;
//the first series is location history, not consumption!
function requestData(){
  $.ajax({
        url: '/realtime/'+personID,
        success: render,
        dataType:"json",
        cache: false
  });
  function render(input){
    console.log("input",d=input);
    if(!input.personal || typeof input.personal.consumptions == 'undefined'){
      $('#myModal').modal({backdrop:'static', keyboard:0})
      return;
    }
    var ts=input.timestamp*1000;
    if(input.location.id != LastRoom){
      LastRoom=input.location.id;
      var roomName=input.location.name;
      chart.series[0].addPoint({
          title:LastRoom,
          text:'You Entered '+'<i>'+roomName+'</i>',
          x:ts
      },true,false);
    }

    input.personal.consumptions.forEach(function(appl){
      var applID=appl['id'];
      console.log(applID, appl['share']);
    if(types.indexOf(applID)<0){
        types.push(applID);
        chart.addSeries({name:applID});
        // TODO: display Names instead
      }
    });

    var visited={};
    input.personal.consumptions.forEach(function(appl){
      var applID=appl['id'];
      var idx=types.indexOf(applID);
      var val=input.personal.type_aggregate[applID].value;
      var doshift=chart.series[idx].length > maxLen;
      chart.series[idx].addPoint([ts,val],true, doshift);
      visited[applID]=true;
    });

    console.log('visited',visited);
    for(var idx=1;idx<types.length;idx++){
      var t=types[idx];
      if(!visited[t]){
        chart.series[idx].addPoint([ts,0],true, true);
      }
    }

    setTimeout(requestData,reqTime);
  }
}

$(function(){
    chart = new Highcharts.Chart({
        chart: {
            renderTo: 'container',
            defaultSeriesType: 'spline',
            events: {
                load: requestData
            }
        },
        title: {
            text: 'Live energy footprint'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            minPadding: 0.2,
            maxPadding: 0.2,
            title: {
                text: 'Value',
                margin: 80
            }
        },
        series: [{
          type:'flags',
          showInLegend: false,
          onSeries:'',
          name:'Location History'
        }]//series of energy cons will be dynamically added
    });        
});
</script>
<style>
body {
  padding-top: 50px;
  position: relative;
}
.starter-template {
  padding: 40px 15px;
  text-align: center;
}
        .box {border:1px solid grey;background-color:#d3d3d3;}
        .large {font-size:3000%;color:red;}
        #div1 {background-color:blue;}
        #div2 {background-color:red;}
        #div3 {background-color:green;}
        .contentDiv {height:800px;}

</style>
</head>
<body >

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Data not found</h4>
          </div>
          <div class="modal-body">
            <p class="lead">
            Your device ID seems to have no data reported&hellip;</p>
            <p>This may either because the location data haven't arrived into the central system yet, or energy monitors is not reporting energy consumptions in your area. Please come back later.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="location.reload()">Refresh</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="container">
      <div class="starter-template">
        <h1>Realtime Personal Footprint</h1>
          <div id="container" style="height: 440px;" class="panel-body">
          <!--
            <form id="form1" onsubmit="return false;"  class="form-inline">
              <label for="personID">UserID</label>
              <input type="text" class="form-control" id="personID" placeholder="fengyi" value="fengyi">
              <button type="button" class="btn btn-default">Start</button>
            </form>
          -->
        </div>

</div>
</div>
</body>
</html>

