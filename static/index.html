<!doctype>
<html>
<head>
<title> The Energy Footprint System query interface </title>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.bundle.min.js"></script>
 <script type="text/javascript" src="https://www.google.com/jsapi"></script>
 <script> google.load("visualization", "1", {packages:["corechart"]});</script>
<style>
body {
  padding-top: 50px;
  position: relative;
}
.starter-template {
  padding: 40px 15px;
  text-align: center;
}
        .box {border:1px solid grey;background-color:#d3d3d3;}
        .large {font-size:3000%;color:red;}
        #div1 {background-color:blue;}
        #div2 {background-color:red;}
        #div3 {background-color:green;}
        .contentDiv {height:800px;}

</style>
</head>
<body >
   <div class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header"> <a href="" class="navbar-brand">My Website</a>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#div1">Page 1</a></li>
                </ul>
            </div>
        </div>
    </div>
    <hr>

    <div class="container">
      <div class="starter-template">
        <h1>Introduction</h1>
        <p class="lead">This interface is for debugging purpose only.</p>
        <p> It can access arbitrary data (but not modify them); so no need to be careful! </p>
      	
<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingOne">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Query for single person
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
      <div class="panel-body">
		<form id="form1" onsubmit="return false;"  class="form-inline">
		  <div class="form-group">
		    <label for="personID1">UserID</label>
		    <input type="text" class="form-control" id="personID1" placeholder="UNI">
		  </div>
		  <hr/>
		  <div class="form-group">
		    <label for="startDate1">startDate</label>
		    <input type="datetime-local" class="form-control" id="startDate1" data-date-prefill="one-day-before">
		  </div>
		  <div class="form-group">
		    <label for="endDate1">endDate</label>
		    <input type="datetime-local" class="form-control" id="endDate1" data-date-prefill="now">
		  </div>
		  <!--<div class="checkbox">
		    <label>
		      <input type="checkbox"> Check me out
		    </label>
		  </div>-->
		  <button type="button" id="query1" class="btn btn-default">Query</button>
		</form>
		<div id="chart1" class="panel-body" style="height:500px"></div>
		<script>
 		$('#query1').on('click', function () {
		    var $btn = $(this).button('loading');
		    var personID=frm1.personID1.value;
		    if(personID.length<2){
		    	$(frm1.personID1).parent().addClass('has-error');
		    	$btn.button('reset');
		    	return;
		    }
		    $("#personID").removeClass('has-error');
		    $.get("/api/Query/QueryPerson/"+personID,{
		    		start:getUTCSeconds(frm1.startDate1.value),
		    		end:getUTCSeconds(frm1.endDate1.value),
		    		client:"AJAX debug frontend"
	    		},
		    	function(data,status){
		    	console.log(data,status);
		    	$btn.button('reset');
		    	render(data);
		    },'json').fail(function() {
			    alert('Error!'); // or whatever			    
			    $btn.button('reset');
			});
		  });
		  
		  function render(input){
		  	input=input.reverse();
			function distinct_types(input){
	          var types={};
	          input.map(function(s){
	            if(s.type_aggregate)
	              for(var t in s.type_aggregate)
	                types[t]=true;
	          });
	          var ret=[];
	          for(var t in types)
	            ret.push(t);
	          return ret;
	        }
	        var types=distinct_types(input);
	        var type_indices={};for(var i in types)type_indices[types[i]]=1*i;
	        console.log(types,type_indices);
	        var data = new google.visualization.DataTable();
	        var dlen=0;
	        dlen++;data.addColumn('datetime', 'TIME'); // Implicit domain label col.
	        types.forEach(function(t){data.addColumn('number', t);dlen++;});

	        dlen++;data.addColumn({type:'string', role:'annotation'}); // annotation role col.
	        dlen++;data.addColumn({type:'string', role:'annotationText'}); // annotationText col.
	        console.log('dlen',dlen);

	        var lastR=false;
	        for(var i=0;i<input.length;i++){
	          var item=input[i];
	          var ret=new Array(dlen);
	          for(var j=1;j<dlen-2;j++)ret[j]=0;
	          for(var t in item.type_aggregate){
	            ret[ type_indices[t]+1 ]=item.type_aggregate[t].value;
	          }
	          if(item.roomID!=lastR){
	            lastR=''+item.roomID;
	            ret[dlen-2]=lastR;
	            ret[dlen-1]="Entered "+lastR;
	            console.log("enter room",lastR,item.timestamp);
	          }

	          if(!item.timestamp)return;
	          if(ret[0]!=undefined)alert('index access violation');
	          ret[0]=new Date(item.timestamp*1000);
	          //console.log('row',ret);
	          data.addRow(ret);
	        };

	        

			
	        var options = {
	          displayAnnotations: 1,
	          isStacked: 1,
	          //width:800,
	          //height:500,
	          //annotations: {'*': {style: 'line'}}
	        };
	        $(ch1).show(0,function(){
	        	chart.draw(data, options);
	        	$(ch1).slideToggle(0).slideToggle(1000);	
	        });
		  }
		  var ch1=document.getElementById('chart1');
		  var frm1=document.getElementById('form1');
		  var chart = new google.visualization.AreaChart(ch1);
			$(ch1).hide();
		</script>

      </div>
    </div>
  </div>

  
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingTwo">
      <h4 class="panel-title">
        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
           Location History of persons
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
      <div class="panel-body">
        
        <form onsubmit="return false;"  class="form-inline">
		  <div class="form-group">
		    <label for="personID">UserIDs</label>
		    <input type="text" class="form-control" id="personIDs" placeholder="UNI">
		  </div>
		  <hr/>
		  <div class="form-group">
		    <label for="startDate2">startDate</label>
		    <input type="datetime-local" class="form-control" id="startDate2">
		  </div>
		  <div class="form-group">
		    <label for="endDate2">endDate</label>
		    <input type="datetime-local" class="form-control" id="endDate2">
		  </div>
		  <!--<div class="checkbox">
		    <label>
		      <input type="checkbox"> Check me out
		    </label>
		  </div>-->
		  <button type="button" id="query_personal" class="btn btn-default">Query</button>
		</form>
		<div id="chart1" class="panel-body" style="height:500px"></div>
		<script>
		</script>

      </div>
    </div>
  </div>


  
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingTwo">
      <h4 class="panel-title">
        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
           Title
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
      <div class="panel-body">
        	Content
      </div>
    </div>
  </div>


  
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingTwo">
      <h4 class="panel-title">
        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
           Title
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
      <div class="panel-body">
        	Content
      </div>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingThree">
      <h4 class="panel-title">
        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
          Combined graph of all icsl members
        </a>
      </h4>
    </div>
    <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
      <div class="panel-body">
       	Graph content 
      </div>
    </div>
  </div>
</div>

      </div>
    </div><!-- /.container -->


<script>
//TODO: typeahead on username!
Date.prototype.toInputValue = (function() {
    var local = new Date(this);
    local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
    return local.toJSON().slice(0,16);
});
var oneDayBefore=new Date();oneDayBefore.setSeconds((new Date()).getSeconds()-86400);
//document.getElementById('startDate1').value = oneDayBefore.toInputValue();
//document.getElementById('endDate1').value = new Date().toInputValue();
$("[data-date-prefill=now]").val(new Date().toInputValue());
$("[data-date-prefill=one-day-before]").val(oneDayBefore.toInputValue());

function getUTCSeconds(LocalDateStr){
	var utcDate=new Date(LocalDateStr);
	utcDate.setMinutes(utcDate.getMinutes() + utcDate.getTimezoneOffset());
	return Math.floor(+utcDate/1000);
}
</script>


</body>
</html>